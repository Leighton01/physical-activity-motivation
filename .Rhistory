post.ch <- lca.best.ch$posterior
N <- nrow(post.ch)
C <- ncol(post.ch)
entro.ch <- 1 + (1/(N*log(C))) * sum(post.ch * log(post.ch))
entro.ch  # ranges 0–1, higher = better separation
# check each class prob
child.lik$post <- apply(lca.best.ch$posterior, 1, max)
ggplot(child.lik, aes(x = post, fill = factor(class))) +
geom_histogram(binwidth = 0.05, alpha = 0.7, position = "identity") +
labs(x = "Max Posterior Probability", y = "Count", fill = "Class") +
theme_minimal()
# boxplot per class
ggplot(child.lik, aes(x = factor(class), y = post)) +
geom_boxplot(fill = "skyblue") +
labs(x = "Class", y = "Max Posterior Probability") +
theme_minimal()
# Weighted means
child.lik$mins <- child.lik.back$mins
child.lik$age <- child.lik.back$age
child.lik$gender <- child.lik.back$gender
child.lik$eth <- child.lik.back$eth
child.lik$mins.log <- log(child.lik$mins+1)
# probability weighted means
wmeans.child <- colSums(post.ch * child.lik$mins) / colSums(post.ch)
wmeans.log.child <- colSums(post.ch * child.lik$mins.log) / colSums(post.ch)
wsd.child <- sapply(1:ncol(post.ch), function(k) {
sqrt( sum(post.ch[,k] * (child.lik$mins - wmeans.child[k])^2)
/ sum(post.ch[,k]) )
})
wsd.log.child <- sapply(1:ncol(post.ch), function(k) {
sqrt( sum(post.ch[,k] * (child.lik$mins.log - wmeans.log.child[k])^2)
/ sum(post.ch[,k]) )
})
mins.child <- data.frame(
Class = factor(1:ncol(post.ch)),
Mean = wmeans.child,
Mean.log= exp(wmeans.log.child)-1,
SD =wsd.child,
SD.log = wsd.log.child,
SD.low = exp(wmeans.log.child - wsd.log.child) - 1,
SD.up = exp(wmeans.log.child + wsd.log.child) - 1
)
mins.child
ggplot(mins.child, aes(x = Class, y = Mean.log)) +
geom_col() +
labs(x = "Latent Class", y = "Probability-weighted mean minutes")
child.lik$mins.log <- log(child.lik$mins+1)
# probability weighted means
wmeans.child <- colSums(post.ch * child.lik$mins) / colSums(post.ch)
wmeans.log.child <- colSums(post.ch * child.lik$mins.log) / colSums(post.ch)
wsd.child <- sapply(1:ncol(post.ch), function(k) {
sqrt( sum(post.ch[,k] * (child.lik$mins - wmeans.child[k])^2)
/ sum(post.ch[,k]) )
})
wsd.log.child <- sapply(1:ncol(post.ch), function(k) {
sqrt( sum(post.ch[,k] * (child.lik$mins.log - wmeans.log.child[k])^2)
/ sum(post.ch[,k]) )
})
mins.child <- data.frame(
Class = factor(1:ncol(post.ch)),
Mean = wmeans.child,
Mean.log= exp(wmeans.log.child),
SD =wsd.child,
SD.log = wsd.log.child,
SD.low = exp(wmeans.log.child - wsd.log.child) - 1,
SD.up = exp(wmeans.log.child + wsd.log.child) - 1
)
mins.child
ggplot(mins.child, aes(x = Class, y = Mean.log)) +
geom_col() +
labs(x = "Latent Class", y = "Probability-weighted mean minutes")
# Part II Child Regression ------------------------------------------------
# AGE
fit.ch.age <- multinom(class ~ age,
data = child.lik %>% dplyr::select(-post,-mins,-eth,-gender))
library(nnmet)
library(nnet)
# Part II Child Regression ------------------------------------------------
# AGE
fit.ch.age <- multinom(class ~ age,
data = child.lik %>% dplyr::select(-post,-mins,-eth,-gender))
summary(fit.ch.age)
# Odds ratios for easier interpretation
exp(coef(fit.ch.age))
# ETHNICITY
fit.ch.eth <- multinom(class ~ eth,
data = child.lik %>% dplyr::select(-post,-mins,-age,-gender))
summary(fit.ch.eth)
# Odds ratios for easier interpretation
exp(coef(fit.ch.eth))
# GENDER
fit.ch.gender <- multinom(class ~ gender,
data = child.lik %>% dplyr::select(-post,-mins,-eth,-age))
summary(fit.ch.gender)
# Odds ratios for easier interpretation
exp(coef(fit.ch.gender))
probs.child <- poLCA.child[[3]]$probs
# Convert list to a long data frame: one row per variable-response-class
probs.child.l <- lapply(names(probs.child), function(var) {
mat <- probs.child[[var]]
df <- as.data.frame(mat)
df$Response <- rownames(mat)
df$Variable <- var
df
}) %>%
bind_rows() %>%
pivot_longer(
cols = starts_with("Response"),
names_to = "Type",
values_to = "Class"
)
class1.ch <- probs.child.l %>% filter(Class == "class 1: ") %>%
dplyr::select(-Type,-Class) %>%
arrange(Variable) %>%
relocate(Variable, 'Pr(1)','Pr(2)','Pr(3)','Pr(4)')
class2.ch <- probs.child.l %>% filter(Class == "class 2: ") %>%
dplyr::select(-Type,-Class) %>%
arrange(Variable) %>%
relocate(Variable, 'Pr(1)','Pr(2)','Pr(3)','Pr(4)')
class3.ch <- probs.child.l %>% filter(Class == "class 3: ") %>%
dplyr::select(-Type,-Class) %>%
arrange(Variable) %>%
relocate(Variable, 'Pr(1)','Pr(2)','Pr(3)','Pr(4)')
class1.ch
class2.ch
class3.ch
probs.adult <- poLCA.adult[[3]]$probs
# Convert list to a long data frame: one row per variable-response-class
probs.adult.l <- lapply(names(probs.adult), function(var) {
mat <- probs.adult[[var]]
df <- as.data.frame(mat)
df$Response <- rownames(mat)
df$Variable <- var
df
}) %>%
bind_rows() %>%
pivot_longer(
cols = starts_with("Response"),
names_to = "Type",
values_to = "Class"
)
class1.ad <- probs.adult.l %>% filter(Class == "class 1: ") %>%
dplyr::select(-Type,-Class) %>%
arrange(Variable) %>%
relocate(Variable, 'Pr(1)','Pr(2)','Pr(3)','Pr(4)')
class2.ad <- probs.adult.l %>% filter(Class == "class 2: ") %>%
dplyr::select(-Type,-Class) %>%
arrange(Variable) %>%
relocate(Variable, 'Pr(1)','Pr(2)','Pr(3)','Pr(4)')
class3.ad <- probs.adult.l %>% filter(Class == "class 3: ") %>%
dplyr::select(-Type,-Class) %>%
arrange(Variable) %>%
relocate(Variable, 'Pr(1)','Pr(2)','Pr(3)','Pr(4)')
class1.ad
class2.ad
class3.ad
exp(coef(fit.ch.gender))
cbind(exp(coef(fit.ch.age)),exp(coef(fit.ch.eth)),exp(coef(fit.ch.gender)))
or.ch <- cbind(exp(coef(fit.ch.age)),exp(coef(fit.ch.eth)),exp(coef(fit.ch.gender)))
or.ad <- cbind(exp(coef(fit.ad.age)),exp(coef(fit.ad.eth)),exp(coef(fit.ad.gender)))
or.ad
or.ch
# table(adult.lik$class)  # modal assignment
prop.table(table(adult.lik$class))
# INDIVIDUAL CLASSES
# 3, 5, or 6
lca.best.ad <- poLCA.adult[[3]]
# check class size (>0.5 per)
adult.lik$class <- lca.best.ad$predclass
# table(adult.lik$class)  # modal assignment
prop.table(table(adult.lik$class))
prop.table(table(child.lik$class))
mins.child
mins.adult
max(child.lik$age)
adult.var <- data.adult %>% dplyr::select('Motiva_POP',
'motivb_POP',
'motivc_POP',
'motivd_POP',
'motive_POP',
'READYAB1_POP',
'READYOP1_POP',
'motivex2a',
'motivex2b',
'motivex2c',
'motivex2d',
'inclus_a',
'inclus_b',
'inclus_c',
'indev',
'indevtry',
'workactlvl',
'DUR_HVY_CAPPED_SPORTCOUNT_A01',
'DUR_MOD_CAPPED_SPORTCOUNT_A01',
# profile
'Age17','Age3','AgeTGC',
'Age4','Age5','Age5_2',
'Age9','Disab2_POP',
'Gend3','Eth2','Eth7',
'Educ6',
# binary
'Motiva_POP_GR2', 'motivex2c_GR2',
'motivex2a_GR2', 'motivc_POP_GR2',
'READYOP1_POP_GR2')
# data.child <- read.csv('data/child_main.tab', header=T, sep='\t')
# data.adult <- read.csv('data/adult.tab', header=T, sep='\t')
#
child.var <- data.child %>% select('PL_Enjoy_bc_ans', 'PL_Conf_bc_ans',
'PL_Easy_bc_ans', 'PL_GdMe_bc_ans',
'PL_Know_c_ans', 'MO_Opp_c',
'MO_Fit_c', 'MO_Relax_c', 'MO_Fun_c',
'MO_Guilt_c', 'MO_Haveto_b_36',
'MO_Haveto_c_711', 'PR_Fam_c', 'PR_Oth_c',
'Try_bc', 'outdoor_bcd_Overall',
'Exeramt_bc', 'ExeramtMore_bc1_2',
'ExeramtMore_bc2_2', 'ExeramtMore_bc3_2',
'mins_modplus_outschool_Week_ALL',
# profile
'age_11', 'eth2', 'gend3', 'eth6',
'Disab_All_POP',
# binary
'PL_Enjoy_bc_SA_gr2', 'MO_Fun_c_SA',
'MO_Fit_c_SA', 'MO_Guilt_c_SA', 'MO_Opp_c_SA'
)
library(tidyverse)
library(lavaan)
library(ggplot2)
library(nnet)
library(tidyLPA)
library(poLCA)
adult.var <- data.adult %>% dplyr::select('Motiva_POP',
'motivb_POP',
'motivc_POP',
'motivd_POP',
'motive_POP',
'READYAB1_POP',
'READYOP1_POP',
'motivex2a',
'motivex2b',
'motivex2c',
'motivex2d',
'inclus_a',
'inclus_b',
'inclus_c',
'indev',
'indevtry',
'workactlvl',
'DUR_HVY_CAPPED_SPORTCOUNT_A01',
'DUR_MOD_CAPPED_SPORTCOUNT_A01',
# profile
'Age17','Age3','AgeTGC',
'Age4','Age5','Age5_2',
'Age9','Disab2_POP',
'Gend3','Eth2','Eth7',
'Educ6',
# binary
'Motiva_POP_GR2', 'motivex2c_GR2',
'motivex2a_GR2', 'motivc_POP_GR2',
'READYOP1_POP_GR2')
save(adult.var, file = "adult.var.RData")
adult.lik <- adult.lik.back
table(adult.var$Educ6)
adult.lik <- adult.var %>%
mutate(mins=DUR_HVY_CAPPED_SPORTCOUNT_A01+DUR_MOD_CAPPED_SPORTCOUNT_A01) %>%
# 1=strong agree, 5=strong disagree
dplyr::select(enjoy=Motiva_POP,
social=motivex2c,
fit=motivex2a,
guilt=motivc_POP,
opp=READYOP1_POP,
imp=motivb_POP,
dis=motivd_POP, #disappoint
abil=READYAB1_POP, #ability
relx=motivex2b,
chal=motivex2d,
dsbl=Disab2_POP,
gender=Gend3,
age=AgeTGC,
eth=Eth2,
edu=Educ6,
mins
) %>%
filter(dsbl==2,
if_all(c(gender,eth), ~ .x %in% c(1,2)),
if_all(everything(), ~ .x > -1),
edu != 5
) %>%
mutate(dis = 6 - dis,
across(c(abil,chal,enjoy,fit,guilt,imp,opp,relx,dis),
~ case_when(.x==5~4L, TRUE ~ as.integer(.x))),
edu = case_when(.x==6~5L, TRUE~.x)
) %>%
dplyr::select(-dsbl)
adult.lik <- adult.var %>%
mutate(mins=DUR_HVY_CAPPED_SPORTCOUNT_A01+DUR_MOD_CAPPED_SPORTCOUNT_A01) %>%
# 1=strong agree, 5=strong disagree
dplyr::select(enjoy=Motiva_POP,
social=motivex2c,
fit=motivex2a,
guilt=motivc_POP,
opp=READYOP1_POP,
imp=motivb_POP,
dis=motivd_POP, #disappoint
abil=READYAB1_POP, #ability
relx=motivex2b,
chal=motivex2d,
dsbl=Disab2_POP,
gender=Gend3,
age=AgeTGC,
eth=Eth2,
edu=Educ6,
mins
) %>%
filter(dsbl==2,
if_all(c(gender,eth), ~ .x %in% c(1,2)),
if_all(everything(), ~ .x > -1),
edu != 5
) %>%
mutate(dis = 6 - dis,
across(c(abil,chal,enjoy,fit,guilt,imp,opp,relx,dis),
~ case_when(.x==5~4L, TRUE ~ as.integer(.x))),
edu = case_when(edu==6~5L, TRUE~edu)
) %>%
dplyr::select(-dsbl)
table(adult.lik$edu
)
table(adult.var$edu)
table(adult.var$Educ6)
adult.lik.back <- adult.lik
adult.lik <- adult.lik %>% dplyr::select(-mins,-age,-gender,-eth,-edu)
lca.f.adult <- as.matrix(adult.lik) ~ 1
# run 2-7 classes
poLCA.adult <- list()
for(k in 1:7){
poLCA.adult[[k]] <- poLCA(lca.f.adult, data = adult.lik,
nclass = k,
maxiter = 5000,
nrep = 10,          # multiple random starts
na.rm = TRUE,       # not needed if NAs already removed
verbose = TRUE)
}
save(poLCA.adult, file="poLCA.adult.RData")
lca.stats.adult <- data.frame(
Classes = 1:7,
BIC = sapply(poLCA.adult[1:7], function(x) x$bic),
AIC = sapply(poLCA.adult[1:7], function(x) x$aic)
)
# elbow plot
ggplot(lca.stats.adult, aes(x = Classes)) +
geom_line(aes(y = BIC), color = "blue") +
geom_point(aes(y = BIC), color = "blue") +
geom_line(aes(y = AIC), color = "red") +
geom_point(aes(y = AIC), color = "red") +
labs(y = "Information Criterion", x = "Number of Classes",
title = "Elbow Plot for poLCA Model Selection",
caption = "Blue = BIC, Red = AIC") +
theme_minimal()
# INDIVIDUAL CLASSES
# 3, 5, or 6
lca.best.ad <- poLCA.adult[[3]]
# check class size (>0.5 per)
adult.lik$class <- lca.best.ad$predclass
# table(adult.lik$class)  # modal assignment
prop.table(table(adult.lik$class))
# entropy, <0.8 good, higher != better
post.ad <- lca.best.ad$posterior
N <- nrow(post.ad)
C <- ncol(post.ad)
entro.ad <- 1 + (1/(N*log(C))) * sum(post.ad * log(post.ad))
entro.ad  # ranges 0–1, higher = better separation
# check each class prob
adult.lik$post <- apply(lca.best.ad$posterior, 1, max)
ggplot(adult.lik, aes(x = post, fill = factor(class))) +
geom_histogram(binwidth = 0.05, alpha = 0.7, position = "identity") +
labs(x = "Max Posterior Probability", y = "Count", fill = "Class") +
theme_minimal()
# boxplot per class
ggplot(adult.lik, aes(x = factor(class), y = post)) +
geom_boxplot(fill = "skyblue") +
labs(x = "Class", y = "Max Posterior Probability") +
theme_minimal()
# interpret
poLCA.adult[[3]]$probs
# poLCA.adult[[4]]$probs
poLCA.adult[[5]]$probs
# INDIVIDUAL CLASSES
# 3, 5, or 6
lca.best.ad <- poLCA.adult[[5]]
# check class size (>0.5 per)
adult.lik$class <- lca.best.ad$predclass
# table(adult.lik$class)  # modal assignment
prop.table(table(adult.lik$class))
# entropy, <0.8 good, higher != better
post.ad <- lca.best.ad$posterior
N <- nrow(post.ad)
C <- ncol(post.ad)
entro.ad <- 1 + (1/(N*log(C))) * sum(post.ad * log(post.ad))
entro.ad  # ranges 0–1, higher = better separation
# INDIVIDUAL CLASSES
# 3, 5, or 6
lca.best.ad <- poLCA.adult[[4]]
# check class size (>0.5 per)
adult.lik$class <- lca.best.ad$predclass
# table(adult.lik$class)  # modal assignment
prop.table(table(adult.lik$class))
# entropy, <0.8 good, higher != better
post.ad <- lca.best.ad$posterior
N <- nrow(post.ad)
C <- ncol(post.ad)
entro.ad <- 1 + (1/(N*log(C))) * sum(post.ad * log(post.ad))
entro.ad  # ranges 0–1, higher = better separation
# INDIVIDUAL CLASSES
# 3, 5, or 6
lca.best.ad <- poLCA.adult[[3]]
# check class size (>0.5 per)
adult.lik$class <- lca.best.ad$predclass
# table(adult.lik$class)  # modal assignment
prop.table(table(adult.lik$class))
# entropy, <0.8 good, higher != better
post.ad <- lca.best.ad$posterior
N <- nrow(post.ad)
C <- ncol(post.ad)
entro.ad <- 1 + (1/(N*log(C))) * sum(post.ad * log(post.ad))
entro.ad  # ranges 0–1, higher = better separation
# Weighted means
adult.lik$mins <- adult.lik.back$mins
adult.lik$age <- adult.lik.back$age
adult.lik$gender <- adult.lik.back$gender
adult.lik$eth <- adult.lik.back$eth
adult.lik$mins.log <- log(adult.lik$mins+1)
# probability weighted means
wmeans.adult <- colSums(post.ad * adult.lik$mins) / colSums(post.ad)
wmeans.log.adult <- colSums(post.ad * adult.lik$mins.log) / colSums(post.ad)
wsd.adult <- sapply(1:ncol(post.ad), function(k) {
sqrt( sum(post.ad[,k] * (adult.lik$mins - wmeans.adult[k])^2)
/ sum(post.ad[,k]) )
})
wsd.log.adult <- sapply(1:ncol(post.ad), function(k) {
sqrt( sum(post.ad[,k] * (adult.lik$mins.log - wmeans.log.adult[k])^2)
/ sum(post.ad[,k]) )
})
mins.adult <- data.frame(
Class = factor(1:ncol(post.ad)),
Mean = wmeans.adult,
Mean.log= exp(wmeans.log.adult)-1,
SD =wsd.adult,
SD.log = wsd.log.adult,
SD.low = exp(wmeans.log.adult - wsd.log.adult) - 1,
SD.up = exp(wmeans.log.adult + wsd.log.adult) - 1
)
mins.adult
ggplot(mins.adult, aes(x = Class, y = Mean.log)) +
geom_col() +
labs(x = "Latent Class", y = "Probability-weighted mean minutes")
adult.lik$class <- relevel(factor(adult.lik$class), ref = "1")
fit.ad <- multinom(class ~ age + edu + gender + eth,
data = adult.lik %>%
dplyr::select(-post,-mins,-eth,-gender))
adult.lik$edu <- adult.lik.back$edu
adult.lik$class <- relevel(factor(adult.lik$class), ref = "1")
fit.ad <- multinom(class ~ age + edu + gender + eth,
data = adult.lik %>%
dplyr::select(-post,-mins,-eth,-gender))
adult.lik$age <- adult.lik.back$age
adult.lik$gender <- adult.lik.back$gender
adult.lik$eth <- adult.lik.back$eth
adult.lik$class <- relevel(factor(adult.lik$class), ref = "1")
fit.ad <- multinom(class ~ age + edu + gender + eth,
data = adult.lik %>%
dplyr::select(-post,-mins,-eth,-gender))
adult.lik$class <- relevel(factor(adult.lik$class), ref = "3")
fit.ad <- multinom(class ~ age + edu + gender + eth,
data = adult.lik %>%
dplyr::select(-post,-mins))
summary(fit.ad)
# Odds ratios for easier interpretation
exp(coef(fit.ad))
table(adult.lik$gender)
table(adult.lik$eth)
table(adult.lik$age)
adult.lik$class <- relevel(factor(adult.lik$class), ref = "1")
adult.lik$gender <- relevel(factor(adult.lik$gender), ref = "1")
adult.lik$eth <- relevel(factor(adult.lik$eth), ref = "1")
adult.lik$age <- relevel(factor(adult.lik$age), ref = "1")
adult.lik$edu <- relevel(factor(adult.lik$edu), ref = "1")
fit.ad <- multinom(class ~ age + edu + gender + eth,
data = adult.lik %>%
dplyr::select(-post,-mins))
# Odds ratios for easier interpretation
exp(coef(fit.ad))
adult.lik$class <- relevel(factor(adult.lik$class), ref = "3")
fit.ad <- multinom(class ~ age + edu + gender + eth,
data = adult.lik %>%
dplyr::select(-post,-mins))
# Odds ratios for easier interpretation
exp(coef(fit.ad))
summary(fit.ad)
save(poLCA.adult, file="poLCA.adult.RData")
child.lik$age <- child.lik.back$age
child.lik$gender <- child.lik.back$gender
child.lik$eth <- child.lik.back$eth
child.lik$class <- relevel(factor(child.lik$class), ref = "3")
child.lik$gender <- relevel(factor(child.lik$gender), ref = "1")
child.lik$eth <- relevel(factor(child.lik$eth), ref = "1")
fit.ch <- multinom(class ~ age + edu + gender + eth,
data = child.lik %>%
dplyr::select(-post,-mins))
fit.ch <- multinom(class ~ age + gender + eth,
data = child.lik %>%
dplyr::select(-post,-mins))
or.ch <- exp(coef(fit.ch))
or.ch
