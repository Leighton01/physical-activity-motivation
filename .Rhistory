# # Check if collapsing is necessary
# child.lik %>% dplyr::select(-max_post,-mins,-age,-eth) %>%
#   pivot_longer(
#     cols = everything(),   # or specify your Likert vars if df has other columns
#     names_to = "Variable",
#     values_to = "Response"
#   ) %>%
#   group_by(Variable, Response) %>%
#   summarise(n = n(), .groups = "drop_last") %>%
#   #"drop_last" drops the response variable,
#   #so that the next part (proportion) does not calculate within each response
#
#   mutate(prop = n / sum(n)) %>%
#   arrange(Variable, Response) %>% filter(prop < 0.05)
# Check which motives need to be collapsed
prop.table(table(child.var$PL_Enjoy_bc_ans))
prop.table(table(child.var$MO_Fun_c))
prop.table(table(child.var$MO_Fit_c))
prop.table(table(child.var$MO_Opp_c))
prop.table(table(child.var$MO_Guilt_c))
prop.table(table(child.var$MO_Relax_c))
prop.table(table(child.var$PL_Conf_bc_ans))
prop.table(table(child.var$PL_GdMe_bc_ans))
prop.table(table(child.var$Try_bc))
# Only motivex2c, motivex2d had barely above 5%
prop.table(table(adult.var$Motiva_POP))
prop.table(table(adult.var$motivex2c))
prop.table(table(adult.var$motivex2a))
prop.table(table(adult.var$motivc_POP))
prop.table(table(adult.var$READYOP1_POP))
prop.table(table(adult.var$READYAB1_POP))
prop.table(table(adult.var$motivb_POP))
prop.table(table(adult.var$motivex2d))
prop.table(table(adult.var$motivex2b))
child.lik <- child.var %>%
# 1-4, 1=strong agree, 4=strong disagree, 5=can't say
dplyr::select(enjoy=PL_Enjoy_bc_ans,
social=MO_Fun_c,
fit=MO_Fit_c,
opp=MO_Opp_c,
guilt=MO_Guilt_c, #99 instead of 5 for "can't say"
relx=MO_Relax_c,
abl=PL_Conf_bc_ans,
imp=PL_GdMe_bc_ans,
chal=Try_bc,
dsbl=Disab_All_POP,
gender=gend3,
age=age_11,
eth=eth2,
mins=mins_modplus_outschool_Week_ALL
) %>%
filter(dsbl == 2,
gender %in% c(1,2),
eth %in% c(1,2),
mins > -1,
if_all(c(enjoy,social,fit,guilt,opp,imp,chal,relx,abl),
~ .x > -1 & .x < 5)) %>%
mutate(
mins = ifelse(mins > 1680, 1680, mins),
across(c(enjoy,social,fit,guilt,imp,chal,opp,relx,abl),
~ case_when(.x==4~3L, TRUE ~ as.integer(.x))),
age=age-10
) %>%
dplyr::select(-dsbl)
child.lik.back0 <- child.lik
adult.lik <- adult.var %>%
mutate(mins=DUR_HVY_CAPPED_SPORTCOUNT_A01+DUR_MOD_CAPPED_SPORTCOUNT_A01) %>%
# 1=strong agree, 5=strong disagree
dplyr::select(enjoy=Motiva_POP,
social=motivex2c,
fit=motivex2a,
guilt=motivc_POP,
opp=READYOP1_POP,
abl=READYAB1_POP,
imp=motivb_POP,
chal=motivex2d,
relx=motivex2b,
dsbl=Disab2_POP,
gender=Gend3,
age=Age9,
eth=Eth2,
# edu=Educ6,
mins
) %>%
filter(dsbl==2,
if_all(c(gender,eth), ~ .x %in% c(1,2)),
if_all(everything(), ~ .x > -1)
# edu != 5
) %>%
mutate(across(c(enjoy,social,fit,guilt,opp,imp,chal,relx,abl),
~ case_when(.x==5~4L, TRUE ~ as.integer(.x))),
# edu = case_when(edu==6~5L, TRUE~edu),
age = as.integer(case_when(age==2~3L,
age==9~8L,
TRUE~as.integer(age)))-2
) %>%
dplyr::select(-dsbl)
adult.lik.back0 <- adult.lik
# Checks -------------------------------------------------------------------
# Collinearity
dallb1 <- dallb %>% dplyr::select(-gender,-eth,-group)
cor(dallb1, method = "pearson")
# opp, fit and enjoy have mod corr with each other, others ok
# Check adult lik corr
cor(child.lik.back0 %>% dplyr::select(-gender,-eth, -age), method = "pearson")
cor(adult.lik.back0 %>% dplyr::select(-gender,-eth,-age), method = "pearson")
# adult.lik1 <- adult.lik %>% dplyr::select(-gender,-eth, -imp)
# cor(adult.lik1, method = "pearson")
# corrleation too high
# child.lik <- child.lik.back0 %>% dplyr::select(-imp)
# adult.lik <- adult.lik.back0 %>% dplyr::select(-imp)
child.lik.back <- child.lik
adult.lik.back <- adult.lik
# VIF
vif_model <- lm(mins ~ enjoyb + socialb + fitb + guiltb + oppb + relxb, data = dallb1)
vif(vif_model)
# Libraries ---------------------------------------------------------------
set.seed(2025)
library(tidyverse)
library(lavaan)
# SEM ---------------------------------------------------------------------
# Free model
m0 <- '
# Mediators: controlling for age, gender, and ethnicity (group-specific coefficients)
enjoyb ~ c(a1_adult, a1_youth)*age + c(g1_adult, g1_youth)*gender + c(e1_adult, e1_youth)*eth
guiltb ~ c(a2_adult, a2_youth)*age + c(g2_adult, g2_youth)*gender + c(e2_adult, e2_youth)*eth
oppb   ~ c(a3_adult, a3_youth)*age + c(g3_adult, g3_youth)*gender + c(e3_adult, e3_youth)*eth
fitb   ~ c(a4_adult, a4_youth)*age + c(g4_adult, g4_youth)*gender + c(e4_adult, e4_youth)*eth
socialb~ c(a5_adult, a5_youth)*age + c(g5_adult, g5_youth)*gender + c(e5_adult, e5_youth)*eth
relxb~ c(a6_adult, a6_youth)*age + c(g6_adult, g6_youth)*gender + c(e6_adult, e6_youth)*eth
# Main outcome: motives predicting mins, controlling for demographics (group-specific coefficients)
mins ~ c(b1_adult, b1_youth)*enjoyb + c(b2_adult, b2_youth)*guiltb + c(b3_adult, b3_youth)*oppb +
c(b4_adult, b4_youth)*fitb + c(b5_adult, b5_youth)*socialb + c(b6_adult, b6_youth)*relxb
+ c(c_adult, c_youth)*age +
c(g7_adult, g7_youth)*gender + c(e7_adult, e7_youth)*eth
# For Adults
indirect_age_enjoyb_adult  := a1_adult * b1_adult
indirect_age_guiltb_adult  := a2_adult * b2_adult
indirect_age_oppb_adult    := a3_adult * b3_adult
indirect_age_fitb_adult    := a4_adult * b4_adult
indirect_age_socialb_adult := a5_adult * b5_adult
indirect_age_relxb_adult := a6_adult * b6_adult
total_age_adult := c_adult + indirect_age_enjoyb_adult + indirect_age_guiltb_adult +
indirect_age_oppb_adult + indirect_age_fitb_adult +
indirect_age_socialb_adult + indirect_age_relxb_adult
# For Youth
indirect_age_enjoyb_youth  := a1_youth * b1_youth
indirect_age_guiltb_youth  := a2_youth * b2_youth
indirect_age_oppb_youth    := a3_youth * b3_youth
indirect_age_fitb_youth    := a4_youth * b4_youth
indirect_age_socialb_youth := a5_youth * b5_youth
indirect_age_relxb_youth := a6_youth * b6_youth
total_age_youth := c_youth + indirect_age_enjoyb_youth + indirect_age_guiltb_youth +
indirect_age_oppb_youth + indirect_age_fitb_youth +
indirect_age_socialb_youth + indirect_age_relxb_youth
'
f0 <- sem(m0, data = dallb, group = "group")
sem.free <- summary(f0, fit.measures = TRUE, standardized = TRUE)
# Constrain all to be equal
f.con <- sem(m0, dallb, group = "group",
group.equal = c("intercepts", "regressions"))
# Check if significantly different
f0fcon <- anova(f0, f.con)
f0fcon
# Spec one constraint at a time
m1 <- '
# Mediators
enjoyb ~ age + gender + eth
guiltb ~ age + gender + eth
oppb ~ age + gender + eth
fitb ~ age + gender + eth
socialb ~ age + gender + eth
relxb ~ age + gender + eth
# Main outcome
mins ~ c("a1","a1")*enjoyb + guiltb + oppb + fitb + socialb + age + gender + eth + relxb
'
m2 <- '
# Mediators
enjoyb ~ age + gender + eth
guiltb ~ age + gender + eth
oppb ~ age + gender + eth
fitb ~ age + gender + eth
socialb ~ age + gender + eth
relxb ~ age + gender + eth
# Main outcome
mins ~ enjoyb + c(a,a)*guiltb + oppb + fitb + socialb + age + gender + eth + relxb
'
m3 <- '
# Mediators
enjoyb ~ age + gender + eth
guiltb ~ age + gender + eth
oppb ~ age + gender + eth
fitb ~ age + gender + eth
socialb ~ age + gender + eth
relxb ~ age + gender + eth
# Main outcome
mins ~ enjoyb + guiltb + c(a,a)*oppb + fitb + socialb + age + gender + eth + relxb
'
m4 <- '
# Mediators
enjoyb ~ age + gender + eth
guiltb ~ age + gender + eth
oppb ~ age + gender + eth
fitb ~ age + gender + eth
socialb ~ age + gender + eth
relxb ~ age + gender + eth
# Main outcome
mins ~ enjoyb + guiltb + oppb + c(a,a)*fitb + socialb + age + gender + eth + relxb
'
m5 <- '
# Mediators
enjoyb ~ age + gender + eth
guiltb ~ age + gender + eth
oppb ~ age + gender + eth
fitb ~ age + gender + eth
socialb ~ age + gender + eth
relxb ~ age + gender + eth
# Main outcome
mins ~ enjoyb + guiltb + oppb + fitb + c(a,a)*socialb + age + gender + eth + relxb
'
m6 <- '
# Mediators
enjoyb ~ age + gender + eth
guiltb ~ age + gender + eth
oppb ~ age + gender + eth
fitb ~ age + gender + eth
socialb ~ age + gender + eth
relxb ~ age + gender + eth
# Main outcome
mins ~ enjoyb + guiltb + oppb + fitb + c(a,a)*relxb + age + gender + eth + socialb
'
# Small eigenvalue close to 0, does not matter
f1 <- sem(m1, data = dallb, group = "group", meanstructure = TRUE)
f2 <- sem(m2, data = dallb, group = "group", meanstructure = TRUE)
f3 <- sem(m3, data = dallb, group = "group", meanstructure = TRUE)
f4 <- sem(m4, data = dallb, group = "group", meanstructure = TRUE)
f5 <- sem(m5, data = dallb, group = "group", meanstructure = TRUE)
f6 <- sem(m6, data = dallb, group = "group", meanstructure = TRUE)
# Check all models are significantly different from m0
anova(f0, f1)
anova(f0, f2)
anova(f0, f3)
anova(f0, f4)
anova(f0, f5)
anova(f0, f6)
# Put slope diff. in a table
params <- parameterEstimates(f0, standardized = T)
# filter
slopes <- params %>%
filter(lhs == "mins", op == "~") %>%
dplyr::select(var=rhs, group, est, se)
# filtre more
slopes.ad <- slopes %>% filter(group == 1) %>%
dplyr::select(var, est.adult = est, se.adult = se)
slopes.ch <- slopes %>% filter(group == 2) %>%
dplyr::select(var, est.youth = est, se.youth = se)
# join!
slopes.diff <- data.frame()
slopes.diff <- left_join(slopes.ch, slopes.ad, by = "var")
# calculate
slopes.diff <- slopes.diff %>%
mutate(
diff = est.youth - est.adult
# se.diff = sqrt(se.adult^2 + se.youth^2),
# z = diff / se.diff,
# p = 2 * (1 - pnorm(abs(z)))
) %>%
filter(!var %in% c("gender","eth")) %>%
dplyr::select(-se.youth, -se.adult)
slopes.diff
# Libraries ---------------------------------------------------------------
set.seed(2025)
library(tidyverse)
library(Hmisc)
library(ggplot2)
library(nnet)
library(tidyLPA)
library(poLCA)
library(poLCAExtra)
# LCA, Youths -------------------------------------------------------------
child.lik <- child.lik.back
# Predictors (motives)
child.lik.y <- (child.lik %>%
dplyr::select(-mins,-age,-gender,-eth))
child.lik.y <- as.matrix(child.lik.y %>% mutate(across(everything(), as.integer)))
# Spec formula for LCA
lca.f.child <- child.lik.y ~ gender + eth
# Run LCA with 2-7 classes
# LCAE.ch <- poLCA(lca.f.child, data = child.lik, nclass = 2:7)
# save(LCAE.ch, file="LCAE.ch.RData")
load("LCAE.ch.RData")
# bootstrapped Vuong-Lo-Mendell-Rubin likelihood ratio test
# blrt.ch <- poLCA.blrt(LCAE.ch,quick = T, nrep=10)
# save(blrt.ch,file="blrt.ch.RData")
# load("blrt.ch.RData")
# Output
ch.lca.output <- LCAE.ch$output %>% dplyr::select(nclass,llike,AIC,BIC,
Rel.Entropy,LMR,p)
ch.lca.output
# check max posterior
# for(k in 2:4){
#
#   child.lik$post <- apply(LCAE.ch$LCA[[k]]$posterior, 1, max)
#
#   child.lik$class <- LCAE.ch$LCA[[k]]$predclass
#
#   print(
#     ggplot(child.lik, aes(x = post, fill = factor(class))) +
#     geom_histogram(binwidth = 0.05, alpha = 0.7, position = "identity") +
#     labs(x = "Max Posterior Probability", y = "Count", fill = "Class",
#          title = paste0(k+1," Classes, Youths")) +
#     theme_minimal()
#   )
#
#   print(ggplot(child.lik, aes(x = factor(class), y = post)) +
#     geom_boxplot(fill = "skyblue") +
#     labs(x = "Class", y = "Max Posterior Probability",
#          title = paste0(k+1," Classes, Youths")) +
#     theme_minimal()
#   )
# }
# Compare 3 and 4 class average posterior and class prop
post4.ch <- LCAE.ch$LCA[[3]]$posterior
class4.ch <- apply(post4.ch, 1, which.max)
class.size4.ch <- prop.table(table(class4.ch))
ave.pp4.ch <- sapply(1:ncol(post4.ch), function(k) {
inds <- which(class4.ch == k)
mean(post4.ch[inds, k])
})
post3.ch <- LCAE.ch$LCA[[2]]$posterior
class3.ch <- apply(post3.ch, 1, which.max)
class.size3.ch <- prop.table(table(class3.ch))
ave.pp3.ch <- sapply(1:ncol(post3.ch), function(k) {
inds <- which(class3.ch == k)
mean(post3.ch[inds, k])
})
# BEST CLASS decided
# 3 classes is best
lca.best.ch <- LCAE.ch$LCA[[2]]
child.lik$class <- lca.best.ch$predclass
# child.lik$post <- apply(lca.best.ch$posterior, 1, max)
# Calculate median minutes
n.classes <- 3
wmed.ch <- numeric(n.classes)
wq25.ch <- numeric(n.classes)
wq75.ch <- numeric(n.classes)
for (k in 1:n.classes) {
q <- wtd.quantile(child.lik$mins,
weights = lca.best.ch$posterior[,k],
probs = c(0.25, 0.5, 0.75))
wq25.ch[k] <- q[1]
wmed.ch[k] <- q[2]
wq75.ch[k] <- q[3]
}
# Regressions
child.lik$age <- child.lik.back$age
child.lik$class <- relevel(factor(child.lik$class), ref = "1")
child.lik$age <- relevel(factor(child.lik$age), ref = "1")
fit.ch <- multinom(class ~ age,
data = child.lik)
# odds ratio
or.ch <- exp(coef(fit.ch))
or.ch
sum.fit.ch <- summary(fit.ch)
se <- sum.fit.ch$standard.errors
# Coefficients
coefs.ch <- coef(fit.ch)
# 95% CI for odds ratios
ci.l.ch <- exp(coefs.ch - 1.96 * se)
ci.u.ch <- exp(coefs.ch + 1.96 * se)
# Odds ratios themselves
or <- exp(coefs.ch)
# Combine into a table
or.ci.ch <- data.frame(
CI.lower = round(ci.l.ch, 3),
CI.upper = round(ci.u.ch, 3)
)
colnames(or.ci.ch) <- c("Intercept.L", "Age2.L", "Age3.L", "Age4.L",
"Age5.L","Age6.L","Intercept.U","Age2.U", "Age3.U", "Age4.U",
"Age5.U","Age6.U")
# Check class distribution per age
tb.byage.ch <- child.lik %>%
count(age, class) %>%
pivot_wider(names_from = class, values_from = n, values_fill = 0)
# LCA, Adults -------------------------------------------------------------
adult.lik <- adult.lik.back
# Predictors (motives)
adult.lik.y <- as.matrix(adult.lik %>%
dplyr::select(-mins,-age,-gender,-eth))
# Spec formula for LCA
lca.f.adult <- adult.lik.y ~ gender + eth
# LCAE.ad <- poLCA(lca.f.adult, data = adult.lik, nclass = 2:7)
# save(LCAE.ad, file="LCAE.ad.RData")
load(file="LCAE.ad.RData")
# bootstrapped Vuong-Lo-Mendell-Rubin likelihood ratio test
# blrt.ad <- poLCA.blrt(LCAE.ad, quick = T,nreps = 10)
# save(blrt.ad,file="blrt.ad.RData")
# load(file="blrt.ad.RData")
# Take relevant stats
ad.lca.output <- LCAE.ad$output %>% dplyr::select(nclass,llike,AIC,BIC,
Rel.Entropy,LMR,p)
ad.lca.output
# adeck posterior and boxplots
# for(k in 2:5){
#
#   adult.lik$post <- apply(LCAE.ad$LCA[[k]]$posterior, 1, max)
#   adult.lik$class <- LCAE.ad$LCA[[k]]$predclass
#
#   print(
#     ggplot(adult.lik, aes(x = post, fill = factor(class))) +
#       geom_histogram(binwidth = 0.05, alpha = 0.7, position = "identity") +
#       labs(x = "Max Posterior Probability", y = "Count", fill = "Class",
#            title = paste0(k+1," Classes, Adults")) +
#       theme_minimal()
#   )
#
#   print(ggplot(adult.lik, aes(x = factor(class), y = post)) +
#           geom_boxplot(fill = "skyblue") +
#           labs(x = "Class", y = "Max Posterior Probability",
#                title = paste0(k+1," Classes, Adults")) +
#           theme_minimal()
#   )
# }
# Compare class average posteriors and class prop
post5.ad <- LCAE.ad$LCA[[4]]$posterior
class5.ad <- apply(post5.ad, 1, which.max)
class.size5.ad <- prop.table(table(class5.ad))
ave.pp5.ad <- sapply(1:ncol(post5.ad), function(k) {
inds <- which(class5.ad == k)
mean(post5.ad[inds, k])
})
ave.pp5.ad
post4.ad <- LCAE.ad$LCA[[3]]$posterior
class4.ad <- apply(post4.ad, 1, which.max)
class.size4.ad <- prop.table(table(class4.ad))
ave.pp4.ad <- sapply(1:ncol(post4.ad), function(k) {
inds <- which(class4.ad == k)
mean(post4.ad[inds, k])
})
ave.pp4.ad
post3.ad <- LCAE.ad$LCA[[2]]$posterior
class3.ad <- apply(post3.ad, 1, which.max)
class.size3.ad <- prop.table(table(class3.ad))
ave.pp3.ad <- sapply(1:ncol(post3.ad), function(k) {
inds <- which(class3.ad == k)
mean(post3.ad[inds, k])
})
ave.pp3.ad
# BEST CLASS decided
# 3 classes is best
lca.best.ad <- LCAE.ad$LCA[[2]]
adult.lik$class <- lca.best.ad$predclass
LCAE.ad <- poLCA(lca.f.adult, data = adult.lik, nclass = 2:7)
save(LCAE.ad, file="LCAE.ad.RData")
prop.table(table(adult.lik$gender
))
prop.table(table(adult.lik$eth))
prop.table(table(child.lik$eth))
prop.table(table(child.lik$gender))
prop.table(table(child.lik$age))
rmdwc::rmdcount('Paper.rmd')
gg.vars.ch <- ggplot(child.lik_long, aes(x = factor(age), y = prop, fill = factor(score))) +
geom_col() +
facet_wrap(~variable, nrow = 3, ncol = 3) +
labs(x = "Age group", y = "Proportion", fill = "Score") +
scale_y_continuous(labels = percent_format()) +
theme_clean() +
theme(legend.position = "bottom", axis.text.y = element_text(size = 8))
child.lik_long <- child.lik %>%
pivot_longer(cols = all_of(vars.ch), names_to = "variable", values_to = "score") %>%
count(age, variable, score) %>%
group_by(age, variable) %>%
mutate(prop = n / sum(n))
vars.ch <- setdiff(names(child.lik), c("age","mins","post","class",
"gender","eth","edu"))
child.lik_long <- child.lik %>%
pivot_longer(cols = all_of(vars.ch), names_to = "variable", values_to = "score") %>%
count(age, variable, score) %>%
group_by(age, variable) %>%
mutate(prop = n / sum(n))
gg.vars.ch <- ggplot(child.lik_long, aes(x = factor(age), y = prop, fill = factor(score))) +
geom_col() +
facet_wrap(~variable, nrow = 3, ncol = 3) +
labs(x = "Age group", y = "Proportion", fill = "Score") +
scale_y_continuous(labels = percent_format()) +
theme_clean() +
theme(legend.position = "bottom", axis.text.y = element_text(size = 8))
gg.vars.ch
gg.vars.ad
vars.ad <- setdiff(names(adult.lik), c("age","mins","post","class",
"gender","eth","edu"))
adult.lik_long <- adult.lik %>%
pivot_longer(cols = all_of(vars.ad), names_to = "variable", values_to = "score") %>%
count(age, variable, score) %>%
group_by(age, variable) %>%
mutate(prop = n / sum(n))
gg.vars.ad <- ggplot(adult.lik_long, aes(x = factor(age), y = prop, fill = factor(score))) +
geom_col() +
facet_wrap(~variable, nrow = 3, ncol = 3) +
labs(x = "Age group", y = "Proportion", fill = "Score") +
scale_y_continuous(labels = percent_format()) +
theme_clean() +
theme(legend.position = "bottom")
gg.vars.ad
gg.vars.ch <- ggplot(child.lik_long, aes(x = factor(age), y = prop, fill = factor(score))) +
geom_col() +
facet_wrap(~variable, nrow = 3, ncol = 3) +
labs(x = "Age group", y = "Proportion", fill = "Score") +
scale_y_continuous(labels = percent_format()) +
theme_clean() +
theme(legend.position = "bottom", axis.text.y = element_text(size = 6))
gg.vars.ch
